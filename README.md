# DefectDojo-Nuclei-Subfinder Scanner

Цей Python-скрипт автоматизує процес сканування веб-додатків на вразливості за допомогою **Nuclei**, виявлення субдоменів за допомогою **Subfinder** та інтеграції результатів з платформою управління вразливостями **DefectDojo**. Він призначений для спрощення робочого процесу, забезпечуючи автоматичний пошук, створення (за потреби) та оновлення `engagements` у DefectDojo на основі кореневих доменів.

---

## Зміст

1.  [Огляд](#1-огляд)
2.  [Передумови](#2-передумови)
    * [Системні вимоги](#системні-вимоги)
    * [Встановлення інструментів](#встановлення-інструментів)
    * [Налаштування DefectDojo](#налаштування-defectdojo)
3.  [Налаштування скрипта](#3-налаштування-скрипта)
    * [Ключ API DefectDojo та URL](#ключ-api-defectdojo-та-url)
    * [ID продукту DefectDojo](#id-продукту-defectdojo)
4.  [Використання](#4-використання)
    * [Запуск скрипта](#запуск-скрипта)
    * [Вхідні параметри](#вхідні-параметри)
    * [Приклади використання](#приклади-використання)
5.  [Логіка роботи](#5-логіка-роботи)
    * [Пошук/Створення Engagement в DefectDojo](#пошукстворення-engagement-в-defectdojo)
    * [Назви звітів (Test Titles)](#назви-звітів-test-titles)
    * [Виявлення субдоменів Subfinder](#виявлення-субдоменів-subfinder)
    * [Перевірка доступності та ProxyChains](#перевірка-доступності-та-proxychains)
6.  [Додатковий функціонал та параметри](#6-додатковий-функціонал-та-параметри)
    * [`--subfinder-proxychains`](#--subfinder-proxychains)
    * `urls.txt` файл](#urlstxt-файл)
7.  [Обробка помилок та логування](#7-обробка-помилок-та-логування)
8.  [Майбутні покращення (Потенційні розширення)](#8-майбутні-покращення-потенційні-розширення)

---

## 1\. Огляд

Цей скрипт є універсальним інструментом для автоматизації рутинних завдань безпеки:

* **Виявлення субдоменів**: Використовує **Subfinder** для автоматичного пошуку субдоменів для заданого кореневого домену.
* **Сканування вразливостей**: Застосовує **Nuclei** для сканування виявлених або наданих URL-адрес на наявність відомих вразливостей (CVE).
* **Інтеграція з DefectDojo**: Автоматично управляє `engagements` у DefectDojo:
    * Шукає існуючий `engagement` за **кореневим доменом** (наприклад, `example.com` для `sub.example.com`).
    * Якщо `engagement` знайдено, завантажує звіт Nuclei до нього.
    * Якщо `engagement` не знайдено, створює новий `engagement` з назвою, що відповідає кореневому домену, а потім завантажує звіт.
* **Гнучкість мережі**: Підтримує роботу через `proxychains` для Nuclei та Subfinder, що корисно при скануванні з обмежених мереж або через проксі.

---

## 2\. Передумови

### Системні вимоги

* **Python 3.x**
* **DefectDojo** (інстальований та запущений)
* **Доступ до інтернету** (для сканування та взаємодії з DefectDojo)

### Встановлення інструментів

1.  **Python залежності**:
    ```bash
    pip install requests
    ```
2.  **Nuclei**:
    Встановіть Nuclei, дотримуючись інструкцій з офіційного репозиторію:
    [https://github.com/projectdiscovery/nuclei](https://github.com/projectdiscovery/nuclei)
    Переконайтеся, що `nuclei` знаходиться у вашому системному `PATH`.
3.  **Subfinder**:
    Встановіть Subfinder, дотримуючись інструкцій з офіційного репозиторію:
    [https://github.com/projectdiscovery/subfinder](https://github.com/projectdiscovery/subfinder)
    Переконайтеся, що `subfinder` знаходиться у вашому системному `PATH`.
4.  **ProxyChains (необов'язково)**:
    Якщо ви плануєте використовувати `proxychains` для маршрутизації трафіку інструментів (Nuclei, Subfinder) через проксі-сервер (наприклад, Tor або SOCKS5), встановіть його.
    * **Для Debian/Ubuntu**: `sudo apt-get install proxychains`
    * **Для macOS (Homebrew)**: `brew install proxychains-ng`
    * Налаштуйте файл конфігурації `proxychains.conf` (зазвичай `/etc/proxychains.conf` або `~/.proxychains/proxychains.conf`) відповідно до ваших налаштувань проксі.

### Налаштування DefectDojo

1.  **Створіть ключ API**: Увійдіть в DefectDojo, перейдіть до **Your Profile** -> **API v2 Key** і скопіюйте ваш ключ.
2.  **Визначте ID продукту**: Цей скрипт працює з певним ID продукту DefectDojo (за замовчуванням `product=2`). Переконайтеся, що цей продукт існує у вашому DefectDojo, або змініть його в коді скрипта. Ви можете знайти ID продукту, перейшовши до сторінки продукту в DefectDojo і подивившись на URL (наприклад, `http://your-dojo/product/<ID_ПРОДУКТУ>`).

---

## 3\. Налаштування скрипта

Відкрийте файл `scan_nuclei_dd.py` і відредагуйте наступні змінні у функції `main()`:

### Ключ API DefectDojo та URL

```python
def main():
    api_key = "ВАШ_API_КЛЮЧ"  # Замініть на ваш DefectDojo API ключ
    defectdojo_url = "http://ВАШ_DEFECTDOJO_URL:ПОРТ"  # Замініть на URL вашого DefectDojo
    input_file = "urls.txt"  # Назва файлу для вхідних URL/доменів, якщо не передано аргументів
    # ...
````

Замініть `ВАШ_API_КЛЮЧ` та `ВАШ_DEFECTDOJO_URL:ПОРТ` на ваші фактичні дані.

### ID продукту DefectDojo

За замовчуванням скрипт використовує `product=2` при пошуку та створенні `engagements`. Якщо вам потрібно працювати з іншим продуктом, змініть значення `product` у функціях `get_existing_engagement` та `create_engagement`.

```python
# У get_existing_engagement
response = requests.get(f"{defectdojo_url}/api/v2/engagements/?product=2", headers=headers)
# ...
# У create_engagement
data = {
    # ...
    "product": 2, # product_id
    # ...
}
```

-----

## 4\. Використання

### Запуск скрипта

```bash
python3 scan_nuclei_dd.py [Вхідні_Цілі] [Опції]
```

### Вхідні параметри

Ви можете надати цілі для сканування двома способами:

1.  **Через аргументи командного рядка**:
    Передайте URL-адреси або кореневі домени безпосередньо після назви скрипта.

      * **Приклад кореневого домену**: `example.com` (Subfinder буде шукати субдомени, а потім Nuclei скануватиме їх).
      * **Приклад повного URL**: `http://sub.example.com` або `https://another.domain.net/path` (Nuclei скануватиме лише цей URL).

2.  **Через файл `urls.txt`**:
    Якщо аргументи командного рядка не надані, скрипт автоматично спробує прочитати цілі з файлу `urls.txt` у тій же директорії. Кожен URL або домен повинен бути на новому рядку.

### Приклади використання

  * **Сканування кореневого домену (з виявленням субдоменів Subfinder'ом)**:

    ```bash
    python3 scan_nuclei_dd.py example.com
    ```

    (Subfinder знайде `sub.example.com`, `email2.example.com` тощо, а потім кожен з них буде просканований Nuclei.)

  * **Сканування кореневого домену (з Subfinder через ProxyChains)**:

    ```bash
    python3 scan_nuclei_dd.py --subfinder-proxychains example.com
    ```

    (Subfinder буде працювати через ProxyChains, Nuclei автоматично визначить необхідність ProxyChains.)

  * **Сканування конкретного URL (без Subfinder)**:

    ```bash
    python3 scan_nuclei_dd.py [http://specific.example.com/login](http://specific.example.com/login)
    ```

    (Nuclei скануватиме тільки `http://specific.example.com/login`. Якщо ресурс недоступний напряму, буде використано ProxyChains для Nuclei.)

  * **Використання файлу `urls.txt`**:
    Якщо `urls.txt` містить:

    ```
    example.com
    [http://dev.anothersite.org](http://dev.anothersite.org)
    test.net
    ```

    Тоді запустіть:

    ```bash
    python3 scan_nuclei_dd.py
    ```

    Скрипт запустить Subfinder для `example.com` та `test.net`, а `http://dev.anothersite.org` буде проскановано напряму Nuclei.

-----

## 5\. Логіка роботи

### Пошук/Створення Engagement в DefectDojo

Скрипт реалізує наступний розумний підхід до управління `engagements`:

1.  Для кожної URL-адреси, що підлягає скануванню Nuclei (незалежно від того, чи була вона отримана від Subfinder'а, чи надана безпосередньо), скрипт спочатку **витягує її кореневий домен** (наприклад, `example.com` з `http://sub.example.com` або `www.example.co.uk`).
2.  Далі він виконує запит до DefectDojo, щоб знайти **існуючий `engagement`**, назва якого (після очищення до кореневого домену) **точно збігається** з кореневим доменом поточної цілі.
3.  Якщо такий `engagement` **знайдено**, звіт Nuclei завантажується саме в цей `engagement`.
4.  Якщо такий `engagement` **не знайдено**, скрипт **створює новий `engagement`** у DefectDojo. Назва нового `engagement` буде відповідати кореневому домену цілі. Після створення звіт завантажується до нього.

Цей підхід забезпечує, що всі скани, які належать до одного кореневого домену (навіть якщо вони є субдоменами або різними шляхами), будуть агреговані в одному `engagement` у DefectDojo.

### Назви звітів (Test Titles)

  * **Назва `engagement`**: Завжди відповідає **кореневому домену** (наприклад, `example.com`).
  * **Назва звіту (Test Title)** у DefectDojo: Містить **повне доменне ім'я** (включно із субдоменами, але без протоколу, `www.` та порту). Наприклад, для `http://email2.example.com/path`, `Test Title` буде `email2.example.com`. Це дозволяє легко відрізняти звіти для різних субдоменів в рамках одного `engagement`.

### Виявлення субдоменів Subfinder

  * Скрипт розрізняє **кореневі домени** (для яких потрібно запускати Subfinder) та **повні URL/субдомени** (для прямого сканування Nuclei).
  * **Кореневий домен** для Subfinder визначається, якщо вхідний рядок:
      * Не починається з `http://` або `https://`.
      * Не містить символу `/` (тобто не є шляхом URL).
      * Його кореневий домен, виділений скриптом, збігається з самим вхідним рядком (наприклад, `example.com` залишається `example.com`, а `sub.example.com` стає `example.com` і не вважається кореневим для Subfinder).
  * Для кожного знайденого субдомена (а також для самого кореневого домену), скрипт додає як `http://`, так і `https://` версії до списку цілей для Nuclei.

### Перевірка доступності та ProxyChains

  * Перед запуском Nuclei, скрипт намагається перевірити доступність цільового URL.
  * Якщо ресурс **доступний**, Nuclei запускається без `proxychains`.
  * Якщо ресурс **недоступний** (наприклад, через обмеження брандмауера або мережі), Nuclei запускається через `proxychains`.
  * Для Subfinder ви можете явно вказати використання `proxychains` за допомогою аргументу `--subfinder-proxychains`.

-----

## 6\. Додатковий функціонал та параметри

### `--subfinder-proxychains`

Цей аргумент вказує скрипту запускати `subfinder` через `proxychains`. Це корисно, якщо вам потрібно, щоб Subfinder виконував запити через проксі (наприклад, для обходу обмежень швидкості або цензури).

**Приклад**:

```bash
python3 scan_nuclei_dd.py --subfinder-proxychains example.com
```

### `urls.txt` файл

Якщо ви запускаєте скрипт без аргументів командного рядка, він автоматично шукатиме файл `urls.txt` у тій же директорії. Цей файл може містити список цілей (по одному на рядок), які можуть бути як кореневими доменами, так і повними URL-адресами.

-----

## 7\. Обробка помилок та логування

Скрипт надає детальне логування в консоль, щоб ви могли відстежувати його прогрес:

  * Повідомлення про запуск Subfinder, знайдені субдомени.
  * Повідомлення про перевірку доступності URL.
  * Інформація про запуск Nuclei та його завершення.
  * Повідомлення про взаємодію з DefectDojo: пошук існуючих `engagements`, створення нових, завантаження звітів.
  * Детальна інформація про помилки API DefectDojo або проблеми із запуском інструментів.
  * Тимчасові файли звітів Nuclei (`<root_domain>_nuclei_report.json`) автоматично видаляються після успішного завантаження до DefectDojo.

---


